# Expense Approval Workflow (Business)
# Demonstrates a real approval flow where logic is explicit and ND is limited to message tone.

@meta target=cli
@meta nd_budget=8

module(Business.Finance.ExpenseApproval):
  use(cli.ui)
  use(cli.input, as: input)

  flow(App):
    start > Inbox

    state(Inbox):
      ui.text("Expense Queue", color: "yellow")
      ui.text("1 = Open request, Esc = Exit", color: "blue")
      on input.key(1) > Review
      on input.key(Esc) > Exit
    end

    state(Review):
      ui.text("Request #EX-2048", color: "yellow")
      ui.text("Amount: 890 EUR", color: "white")
      ui.text("Category: Travel", color: "white")
      ui.text("A = Approve, R = Reject, N = Need Info", color: "blue")
      on input.key(A):: approvedCount += 1
      on input.key(R):: rejectedCount += 1
      on input.key(N):: infoCount += 1
      on input.key(A) > Approved
      on input.key(R) > Rejected
      on input.key(N) > NeedInfo
      on input.key(Esc) > Inbox

      rule(autoEscalate):
        when riskScore >= 70 and queueSize > 10 or amount == 5000:
          emit escalated
        end
      end

      on escalated > NeedInfo
    end

    state(Approved):
      ui.text("Approved and forwarded to payout batch.", color: "green")
      on input.key(Enter) > Inbox
    end

    state(Rejected):
      ui.text("Rejected with reason code.", color: "red")
      on input.key(Enter) > Inbox
    end

    state(NeedInfo):
      ui.text("Sent request for additional receipt details.", color: "magenta")
      on input.key(Enter) > Inbox
    end

    state(Exit):
      terminate
    end
  end

  state():
    amount = 890
    approvalLimit = 1000
    queueSize = 12
    selectedRequest = "EX-2048"
    riskScore = 18
    approvedCount = 0
    rejectedCount = 0
    infoCount = 0
  end

  rule(policyCheck):
    when riskScore >= 80:
      emit done
    end
  end

  nd(copyStyle):
    propose reviewCopyTone(audience: "finance-team")
    satisfy(
      conciseLanguage(),
      noLegalRiskTerms(),
      professionalTone()
    )
  end

end
